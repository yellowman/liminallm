# LiminalLM OpenBSD httpd.conf
# Place in /etc/httpd.conf

# Prefork configuration
prefork 4

# Types
types {
	include "/usr/share/misc/mime.types"
}

# Logging
log style combined

# Main server - HTTP redirect to HTTPS
server "liminallm" {
	listen on * port 80

	# ACME challenge for Let's Encrypt
	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}

	# Redirect all other traffic to HTTPS
	location "*" {
		block return 301 "https://$HTTP_HOST$REQUEST_URI"
	}
}

# HTTPS server with TLS
server "liminallm" {
	listen on * tls port 443

	# TLS configuration
	tls {
		certificate "/etc/ssl/liminallm.crt"
		key "/etc/ssl/private/liminallm.key"
		protocols "TLSv1.2,TLSv1.3"
		ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
	}

	# Connection limits
	connection max request body 10485760  # 10MB

	# HSTS header
	hsts max-age 31536000

	# Health check - no auth required
	location "/v1/health" {
		fastcgi socket "/run/liminallm/fcgi.sock"
	}

	# API routes
	location "/v1/*" {
		fastcgi socket "/run/liminallm/fcgi.sock"
	}

	# WebSocket upgrade for streaming chat
	# Note: OpenBSD httpd has limited WebSocket support
	# Consider using relayd for WebSocket proxying
	location "/v1/chat/stream" {
		fastcgi socket "/run/liminallm/fcgi.sock"
	}

	# Static frontend files from the app
	location "/*" {
		fastcgi socket "/run/liminallm/fcgi.sock"
	}
}

# Alternative: Direct reverse proxy without FastCGI
# Uncomment and adjust if running uvicorn directly
#
# server "liminallm-proxy" {
# 	listen on * tls port 443
#
# 	tls {
# 		certificate "/etc/ssl/liminallm.crt"
# 		key "/etc/ssl/private/liminallm.key"
# 	}
#
# 	# Use relayd for reverse proxy instead
# 	# httpd doesn't support reverse proxy natively
# }
