# LiminalLM OpenBSD relayd.conf
# Place in /etc/relayd.conf
# relayd provides reverse proxy with WebSocket support

# Macros
ext_addr="egress"
liminallm_backend="127.0.0.1"
liminallm_port="8000"

# Logging
log state changes
log connection errors

# Global options
interval 10
timeout 1000
prefork 4

# Protocol for HTTP traffic
http protocol "liminallm_http" {
	# Match all requests
	match request header append "X-Forwarded-For" value "$REMOTE_ADDR"
	match request header append "X-Forwarded-Proto" value "https"
	match request header set "X-Real-IP" value "$REMOTE_ADDR"

	# WebSocket support for streaming
	match request header "Upgrade" value "websocket" tag "websocket"
	match request tagged "websocket" header append "Connection" value "upgrade"

	# Security headers
	match response header set "X-Frame-Options" value "SAMEORIGIN"
	match response header set "X-Content-Type-Options" value "nosniff"
	match response header set "X-XSS-Protection" value "1; mode=block"
	match response header set "Referrer-Policy" value "strict-origin-when-cross-origin"

	# Compression
	match response header "Content-Type" value "application/json" compress
	match response header "Content-Type" value "text/*" compress

	# Timeouts for long-running requests (streaming)
	tcp { nodelay, socket buffer 65536 }
}

# TLS protocol
http protocol "liminallm_https" {
	tls keypair "liminallm"

	# Inherit HTTP protocol settings
	match request header append "X-Forwarded-For" value "$REMOTE_ADDR"
	match request header append "X-Forwarded-Proto" value "https"
	match request header set "X-Real-IP" value "$REMOTE_ADDR"

	# WebSocket support
	match request header "Upgrade" value "websocket" tag "websocket"
	match request tagged "websocket" header append "Connection" value "upgrade"

	# HSTS
	match response header set "Strict-Transport-Security" value "max-age=31536000; includeSubDomains"

	# Security headers
	match response header set "X-Frame-Options" value "SAMEORIGIN"
	match response header set "X-Content-Type-Options" value "nosniff"

	tcp { nodelay, socket buffer 65536 }
}

# Backend relay table
table <liminallm> { $liminallm_backend }

# HTTP redirect to HTTPS
relay "liminallm_redirect" {
	listen on $ext_addr port 80
	protocol "liminallm_http"
	forward to <liminallm> port $liminallm_port check http "/v1/health" code 200
}

# Main HTTPS relay
relay "liminallm_https" {
	listen on $ext_addr port 443 tls
	protocol "liminallm_https"
	forward to <liminallm> port $liminallm_port check http "/v1/health" code 200
}
